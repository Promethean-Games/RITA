<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Expo Training v0.2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-elevated: #ffffff;
      --bg-soft: #e5e7eb;
      --text: #111827;
      --muted: #6b7280;
      --accentA: #f97316;
      --accentB: #facc15;
      --accent: var(--accentA);
      --accent-soft: rgba(249, 115, 22, 0.1);
      --border: #d1d5db;
      --danger: #b91c1c;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-soft: 0 14px 30px rgba(15, 23, 42, 0.12);
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      background: var(--bg);
      font-family: var(--font-main);
      color: var(--text);
    }

    .app-shell {
      width: 100%;
      max-width: 480px;
      min-height: 100vh;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    header {
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
      background: var(--bg-elevated);
      box-shadow: 0 1px 0 rgba(15, 23, 42, 0.03);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-inner {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .header-logo {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .header-logo-text {
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.25rem 0.9rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 0.86rem;
    }

    .icon-btn {
      border: none;
      background: transparent;
      padding: 0.3rem;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
    }

    .icon-btn:hover {
      background: var(--bg-soft);
      color: var(--text);
    }

    .icon {
      width: 18px;
      height: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    main {
      flex: 1;
      padding: 0.75rem 1rem 0.8rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .card {
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 0.85rem 0.9rem;
    }

    .card + .card {
      margin-top: 0.25rem;
    }

    h2 {
      margin: 0 0 0.4rem;
      font-size: 1rem;
    }

    h3 {
      margin: 0 0 0.3rem;
      font-size: 0.95rem;
    }

    p {
      margin: 0;
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .muted {
      color: var(--muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: var(--accent-soft);
      color: var(--accentA);
      font-weight: 500;
      margin-bottom: 0.35rem;
    }

    .progress-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .progress-label {
      font-size: 0.85rem;
      font-weight: 500;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: var(--bg-soft);
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accentA), var(--accentB));
      width: 0%;
      transition: width 0.2s ease-out;
    }

    .alert {
      border-radius: var(--radius-md);
      padding: 0.5rem 0.6rem;
      border: 1px solid var(--border);
      background: var(--bg-soft);
      font-size: 0.82rem;
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .alert.complete {
      border-color: rgba(34, 197, 94, 0.4);
      background: rgba(22, 163, 74, 0.05);
    }

    .alert strong {
      display: block;
      margin-bottom: 0.15rem;
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-top: 0.3rem;
    }

    .list-item {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 0.55rem 0.65rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      background: var(--bg-elevated);
      cursor: pointer;
      font-size: 0.86rem;
      transition: background 0.15s ease, border-color 0.15s ease;
    }

    .list-item span.label {
      flex: 1;
    }

    .list-item span.meta {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .list-item.status-required {
      background: var(--accent-soft);
      border-color: var(--accentA);
    }

    .list-item.status-complete {
      background: rgba(34, 197, 94, 0.08);
      border-color: rgba(34, 197, 94, 0.45);
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 0.55rem 0.9rem;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      margin-top: 0.4rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      color: #111827;
      font-weight: 600;
      width: 100%;
      transition: background 0.15s ease, opacity 0.15s ease;
    }

    .btn-primary[disabled] {
      opacity: 0.6;
      cursor: default;
    }

    .btn-primary.completed {
      background: linear-gradient(135deg, #22c55e, #4ade80);
      color: #022c22;
    }

    .btn-outline {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
    }

    .divider {
      border-top: 1px solid var(--border);
      margin: 0.5rem 0;
    }

    footer {
      flex-shrink: 0;
      border-top: 1px solid var(--border);
      background: var(--bg-elevated);
      position: sticky;
      bottom: 0;
      z-index: 5;
    }

    .tabbar {
      display: flex;
      align-items: center;
      justify-content: space-around;
      padding: 0.4rem 0.2rem 0.55rem;
    }

    .tab-btn {
      flex: 1;
      border: none;
      background: transparent;
      padding: 0.35rem 0;
      font-size: 0.8rem;
      color: var(--muted);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.15rem;
    }

    .tab-btn span.dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: transparent;
    }

    .tab-btn.active {
      color: var(--accentA);
      font-weight: 600;
    }

    .tab-btn.active span.dot {
      background: var(--accentA);
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .steps {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-top: 0.4rem;
    }

    .step-row {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .step-row input[type="checkbox"] {
      margin-top: 0.1rem;
      flex-shrink: 0;
    }

    .step-row span {
      flex: 1;
    }

    .hint {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 0.25rem;
    }

    .settings-group {
      margin-top: 0.3rem;
    }

    .settings-item {
      padding: 0.55rem 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
      cursor: pointer;
    }

    .settings-item.no-click {
      cursor: default;
    }

    .settings-item.no-click > span {
      pointer-events: none;
    }

    .settings-select {
      font-size: 0.8rem;
      padding: 0.2rem 0.4rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text);
    }

    .empty-state {
      font-size: 0.85rem;
      color: var(--muted);
      padding: 0.4rem 0;
    }

    /* Module image / carousel */
    .module-image-wrapper {
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      margin: 0.4rem 0 0.6rem;
      border: 1px solid var(--border);
      background: var(--bg-soft);
      display: flex;
      flex-direction: column;
    }

    .module-image-main {
      width: 100%;
    }

    .module-image-main img {
      width: 100%;
      height: auto;
      aspect-ratio: 16 / 9;
      object-fit: cover;
      display: block;
    }

    .module-image-placeholder {
      width: 100%;
      aspect-ratio: 16 / 9;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.78rem;
      color: var(--muted);
      padding: 0.5rem;
      text-align: center;
    }

    .module-carousel-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.3rem 0.6rem;
      background: var(--bg-elevated);
      border-top: 1px solid var(--border);
      font-size: 0.78rem;
    }

    .module-carousel-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 0.2rem 0.4rem;
      border-radius: 999px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
    }

    .module-carousel-btn:hover {
      background: var(--bg-soft);
      color: var(--text);
    }

    .module-carousel-counter {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 76px;
      background: var(--bg-elevated);
      color: var(--text);
      border-radius: 999px;
      padding: 0.55rem 0.9rem;
      font-size: 0.8rem;
      border: 1px solid var(--border);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease-out, transform 0.2s ease-out;
      transform-origin: center;
      z-index: 40;
      white-space: nowrap;
      max-width: 90%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .toast.show {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(-50%) translateY(-4px);
    }

    /* Accordion */
    .accordion {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-top: 0.35rem;
    }

    .accordion-item {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      overflow: hidden;
    }

    .accordion-header {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border: none;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .accordion-title {
      font-weight: 600;
      font-size: 0.86rem;
    }

    .accordion-meta {
      font-size: 0.75rem;
      color: var(--muted);
      margin-left: 0.4rem;
    }

    .accordion-chevron {
      font-size: 0.8rem;
      margin-left: 0.5rem;
      transition: transform 0.15s ease-out;
    }

    .accordion-body {
      padding: 0 0.6rem 0.55rem;
      border-top: 1px solid var(--border);
      display: none;
    }

    .accordion-item.open .accordion-body {
      display: block;
    }

    .accordion-item.open .accordion-chevron {
      transform: rotate(180deg);
    }

    /* Quiz modal */
    .quiz-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .quiz-overlay.show {
      display: flex;
    }

    .quiz-card {
      background: var(--bg-elevated);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 0.85rem 0.9rem;
      width: 92%;
      max-width: 420px;
    }

    .quiz-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .quiz-question {
      font-size: 0.85rem;
      margin-bottom: 0.6rem;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-bottom: 0.6rem;
    }

    .quiz-option-row {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
    }

    .quiz-option-row input[type="radio"] {
      flex-shrink: 0;
    }

    .quiz-input {
      width: 100%;
      font-size: 0.85rem;
      padding: 0.4rem 0.5rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-elevated);
      color: var(--text);
      margin-bottom: 0.4rem;
    }

    .quiz-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .quiz-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      background: transparent;
      padding: 0.45rem 0.85rem;
      font-size: 0.82rem;
      cursor: pointer;
    }

    .quiz-btn-primary {
      border: none;
      background: linear-gradient(135deg, var(--accentA), var(--accentB));
      color: #111827;
      font-weight: 600;
    }

    .quiz-error {
      font-size: 0.78rem;
      color: var(--danger);
      min-height: 1em;
      margin-bottom: 0.2rem;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="header-inner">
        <button class="icon-btn" id="backButton" aria-label="Back" style="display:none;">
          <span class="icon">
            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </span>
        </button>

        <div class="header-logo">
          <span class="header-logo-text" id="headerTitle">Texican Logo</span>
        </div>

        <button class="icon-btn" id="settingsButton" aria-label="Settings">
          <span class="icon" aria-hidden="true">⚙</span>
        </button>
      </div>
    </header>

    <main>
      <!-- HOME VIEW -->
      <section id="view-home" class="view active">
        <div class="card">
          <div class="pill">Dashboard</div>
          <div class="progress-row">
            <div>
              <div class="progress-label" id="progressLabel">
                0 / 0 Modules Completed
              </div>
              <div class="muted" style="font-size:0.78rem;">
                All modules are required.
              </div>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div id="homeAlertContainer"></div>
        </div>

        <div class="card">
          <h3>Assigned Training</h3>
          <p class="muted" style="font-size:0.8rem;">
            These modules are required for your Expo role.
          </p>
          <div id="homeAssignedAccordion"></div>
        </div>
      </section>

      <!-- MODULES LIST VIEW -->
      <section id="view-modules" class="view">
        <div class="card">
          <h2>Modules by Role</h2>
          <p class="muted" style="font-size:0.8rem;">
            Expo modules are available now. Other roles are coming soon.
          </p>
          <div class="divider"></div>
          <div id="modulesList"></div>
        </div>
      </section>

      <!-- MODULE DETAIL VIEW -->
      <section id="view-module-detail" class="view">
        <div class="card">
          <div class="pill" id="detailCategoryPill">Prep</div>
          <h2 id="detailTitle">Module Title</h2>
          <p class="muted" id="detailDescription" style="font-size:0.8rem;">
            Description goes here.
          </p>

          <div id="detailImageContainer"></div>

          <div class="steps" id="detailSteps"></div>
          <button class="btn btn-primary" id="completeModuleBtn" disabled>
            Mark Module Complete
          </button>
          <p class="hint" id="detailHint"></p>
        </div>
      </section>

      <!-- SETTINGS VIEW -->
      <section id="view-settings" class="view">
        <div class="card">
          <h2>Settings</h2>
          <div class="settings-group">
            <div class="settings-item" id="profileFirstNameRow">
              <span>First Name</span>
              <span class="muted" id="profileFirstNameValue" style="font-size:0.8rem;">Fname</span>
            </div>
            <div class="settings-item" id="profileLastNameRow">
              <span>Last Name</span>
              <span class="muted" id="profileLastNameValue" style="font-size:0.8rem;">Lname</span>
            </div>
            <div class="settings-item" id="profileCommonNameRow">
              <span>Common Name</span>
              <span class="muted" id="profileCommonNameValue" style="font-size:0.8rem;">Optional</span>
            </div>
            <div class="settings-item no-click">
              <span>Location</span>
              <select id="profileLocationSelect" class="settings-select">
                <option value="Kyle">Kyle</option>
                <option value="Other">Other...</option>
              </select>
            </div>
            <div class="settings-item" id="profileEmployeeIdRow">
              <span>Employee ID</span>
              <span class="muted" id="profileEmployeeIdValue" style="font-size:0.8rem;">Not set</span>
            </div>
            <div class="settings-item no-click">
              <span>Notifications</span>
              <span class="muted" style="font-size:0.8rem;">Coming later</span>
            </div>
          </div>
        </div>
      </section>

      <!-- ASSIGNED MODULES VIEW -->
      <section id="view-assigned" class="view">
        <div class="card">
          <h2>Assigned Modules</h2>
          <p class="muted" style="font-size:0.8rem;">
            All training modules are required.
          </p>
          <div class="divider"></div>
          <div id="assignedAccordion"></div>
        </div>
      </section>
    </main>

    <footer>
      <div class="tabbar">
        <button class="tab-btn active" data-tab="home">
          <span>Home</span>
          <span class="dot"></span>
        </button>
        <button class="tab-btn" data-tab="modules">
          <span>Modules</span>
          <span class="dot"></span>
        </button>
      </div>
    </footer>

    <div id="toast" class="toast"></div>

    <!-- Quiz Modal -->
    <div id="quizOverlay" class="quiz-overlay" aria-hidden="true">
      <div class="quiz-card" role="dialog" aria-modal="true" aria-labelledby="quizTitle">
        <div class="quiz-title" id="quizTitle">Quick Check</div>
        <div class="quiz-question" id="quizQuestion"></div>
        <div id="quizOptions" class="quiz-options"></div>
        <input id="quizNumberInput" class="quiz-input" type="number" style="display:none;" />
        <div class="quiz-error" id="quizError"></div>
        <div class="quiz-footer">
          <button type="button" class="quiz-btn" id="quizCancelBtn">Cancel</button>
          <button type="button" class="quiz-btn quiz-btn-primary" id="quizSubmitBtn">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Modules -----------------------------------------------------
    const MODULES = [
      {
        id: "prep_ice_cream_balls",
        title: "Prep — Ice Cream Balls",
        category: "Prep",
        role: "Expo",
        description:
          "Prepare and restock Ice Cream Balls during prep so servers can plate desserts quickly.",
        images: [
          "icb-setup.png",
          "icb-weight.png",
          "icb-label.png",
          "icb-cleanup.png"
        ],
        steps: [
          "Gather ice cream, scale, plastic wrap, corn flakes, and gloves.",
          "Scoop 12 oz. ice cream balls using plastic wrap over scale surface.",
          "Roll each scoop ball in corn flakes until coated.",
          "Place ball back onto scale to wrap with plastic.",
          "Label and store the ice cream balls in the mini-freezer.",
          "Return ice cream, scale, plastic wrap, and corn flakes. Dispose of gloves.",
          "Clean prep surfaces with sanitizer towel."
        ]
      },
      {
        id: "prep_tortilla_trays",
        title: "Prep — Tortilla Trays",
        category: "Prep",
        role: "Expo",
        description:
          "Press and stage tortillas so the line never runs out during service.",
        images: [
          "tt-setup.png",
          "tt-count.png",
          "tt-label.png",
          "tt-cover.png",
          "tt-tie.png"
        ],
        steps: [
          "Gather tortilla dough balls, clean trays, parchment sheets, and a scoop.",
          "Place parchment sheets on trays.",
          "Stack tortillas balls 7 across by 10 high (70 total).",
          "Cover trays with plastic bags.",
          "Label and store in the correct cooler."
        ]
      },
      {
        id: "prep_polish_utensils",
        title: "Prep — Polish Utensils",
        category: "Prep",
        role: "Expo",
        description:
          "Polish and stage utensils so servers can roll silverware quickly.",
        steps: [
          "Sort utensils from dish (steak knives and spoons only).",
          "Place utensils in plastic pitcher filled with hot water.",
          "Use a dry black towel to remove any water spots.",
          "Sort utensils into the correct bins.",
          "Restock the expo station with polished utensils or cover with plastic wrap for later use."
        ]
      },
      {
        id: "prep_make_sauces",
        title: "Prep — Make Sauces",
        category: "Prep",
        role: "Expo",
        description:
          "Batch and label sauces needed on the line: spicy salsa, chipotle ranch, ranch, and others.",
        steps: [
          "Review par for each sauce with your trainer.",
          "Measure ingredients according to the recipe listed.",
          "Blend until smooth.",
          "Transfer to labeled containers.",
          "Label and store in the correct cooler."
        ]
      },
      {
        id: "sauces_overview",
        title: "Sauces Overview",
        category: "Sauces",
        role: "Expo",
        description:
          "Know which sauces pair with which dishes and where they are stored.",
        images: [
          "ketchup.png"
        ],
        steps: [
          "Review each house sauce and its primary dishes.",
          "Locate each sauce on the line and in backup storage.",
          "Check labels and dates before service."
        ]
      },
      {
        id: "closing_duties_basic",
        title: "Closing Duties — Expo Line",
        category: "Closing Duties",
        role: "Expo",
        description:
          "Clean and reset the Expo line so the next shift starts ready to go.",
        steps: [
          "Clear and consolidate pans and containers.",
          "Place sides being saved under the heat lamp.",
          "Dump water from side warmers down drain.",
          "Scour, squeegee, and wipe down expo line and window.",
          "Replace side warmers.",
          "Place saved sides in appropriate cooler.",
          "Wipe down carrying trays and shelves."
        ]
      },
      {
        id: "closing_light_close",
        title: "Closing Duties — Light Close",
        category: "Closing Duties",
        role: "Expo",
        description:
          "Perform essential end-of-shift tasks to reset the Expo and tortilla preparation areas for the following day.",
        steps: [
          "Sweep and store all four black floor mats in their designated location.",
          "Turn off both side warmers to allow safe cool-down.",
          "Wipe down and sanitize the Expo window, ledges, and line surfaces.",
          "Tear down the tortilla machine following the full tortilla-machine module procedure.",
          "Polish and restock utensils as needed for the next shift.",
          "Check Ice Cream Ball inventory and prep additional batches if below par.",
          "Check tortilla tray inventory and prep additional trays if needed."
        ]
      },
      {
        id: "closing_tortilla_machine",
        title: "Closing Duties — Tortilla Machine",
        category: "Closing Duties",
        role: "Expo",
        description:
          "Shut down, clean, and reset the tortilla machine so it’s safe, sanitary, and ready for the next shift.",
        steps: [
          "Power down the tortilla machine following standard shut-off protocol.",
          "Carefully remove the black knob once surfaces have cooled enough to handle.",
          "Remove the faceplate and wash it thoroughly in the dish area.",
          "Disengage and remove the locking pin with heat awareness.",
          "Lift and remove the steel tortilla ramp, placing it in the dish area for cleaning.",
          "Wipe down all accessible surfaces, focusing on flour buildup and heat-retaining areas.",
          "Cover the flour bin with foil to maintain sanitation standards overnight.",
          "Store any remaining tortillas in the appropriate cooler container.",
          "Vacuum hard-to-reach areas to remove flour dust and debris."
        ]
      }
    ];

    const ROLES = [
      { id: "Expo", label: "Expo" },
      { id: "Cashier", label: "Cashier" },
      { id: "Server", label: "Server" },
      { id: "Bar", label: "Bar" },
      { id: "Dish", label: "Dish" },
      { id: "Kitchen", label: "Kitchen" }
    ];

    // All modules go through this variable so we can later swap to API-backed data.
    let allModules = MODULES.slice();
    let currentEmployee = null;

    // ---------- State & Profile ---------------------------------------------
    const STORAGE_KEY = "expoTrainingMvpState_v12";
    const PROFILE_NAME_KEY = "expoTrainingName"; // legacy fallback
    const PROFILE_FIRST_NAME_KEY = "expoTrainingFirstName";
    const PROFILE_LAST_NAME_KEY = "expoTrainingLastName";
    const PROFILE_COMMON_NAME_KEY = "expoTrainingCommonName";
    const PROFILE_LOCATION_KEY = "expoTrainingLocation";
    const PROFILE_EMPLOYEE_ID_KEY = "expoTrainingEmployeeId";
    const CLIENT_ID_KEY = "expoTrainingClientId";

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          return {
            completed: {}
          };
        }
        const parsed = JSON.parse(raw);
        return {
          completed: parsed.completed || {}
        };
      } catch (e) {
        return {
          completed: {}
        };
      }
    }

    let state = loadState();

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function getClientId() {
      let id = localStorage.getItem(CLIENT_ID_KEY);
      if (!id) {
        id = "client_" + Math.random().toString(36).slice(2);
        localStorage.setItem(CLIENT_ID_KEY, id);
      }
      return id;
    }

    function getProfile() {
      const firstName = localStorage.getItem(PROFILE_FIRST_NAME_KEY) || "";
      const lastName = localStorage.getItem(PROFILE_LAST_NAME_KEY) || "";
      const commonName = localStorage.getItem(PROFILE_COMMON_NAME_KEY) || "";

      const legacyFull =
        localStorage.getItem(PROFILE_NAME_KEY) || "Fname Lname";

      let legalName = (firstName + " " + lastName).trim();
      if (!legalName) {
        legalName = legacyFull;
      }

      let displayName = legalName;
      if (commonName && commonName.trim()) {
        displayName = commonName.trim();
      }

      const location =
        localStorage.getItem(PROFILE_LOCATION_KEY) || "Kyle";
      const employee_id =
        localStorage.getItem(PROFILE_EMPLOYEE_ID_KEY) || "";
      const role = "Expo";

      return {
        firstName,
        lastName,
        commonName,
        legalName,
        displayName,
        employee_name: legalName,
        location,
        employee_id,
        role,
        client_id: getClientId()
      };
    }

    function refreshHeaderFromProfile() {
      // Header currently only shows logo text; keep for future use if needed.
    }

    function updateSettingsProfileUI() {
      const profile = getProfile();
      document.getElementById("profileFirstNameValue").textContent =
        profile.firstName || "Fname";
      document.getElementById("profileLastNameValue").textContent =
        profile.lastName || "Lname";
      document.getElementById("profileCommonNameValue").textContent =
        profile.commonName || "Optional";
      document.getElementById("profileEmployeeIdValue").textContent =
        profile.employee_id || "Not set";

      const locationSelect = document.getElementById("profileLocationSelect");
      locationSelect.value = profile.location === "Other" ? "Other" : "Kyle";
    }

    // ---------- Backend sync (Google Sheets) --------------------------------
    const SHEETS_ENDPOINT =
      "https://script.google.com/macros/s/AKfycbykPwcIulm6Tjo8JynUyviawqEDAQA7fqBMIN9I8jukZ9PrzYVO4dECESbh2GnEy9QyCw/exec";

    function syncCompletionToSheet(module, completionPct) {
      const profile = getProfile();

      const payload = {
        timestamp: new Date().toISOString(),
        employee_name: profile.employee_name,
        display_name: profile.displayName,
        employee_id: profile.employee_id,
        location: profile.location,
        role: profile.role,
        module_id: module.id,
        module_title: module.title,
        event_type: "MODULE_COMPLETED",
        completion_pct: completionPct,
        client_id: profile.client_id
      };

      fetch(SHEETS_ENDPOINT, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      }).catch((err) => {
        console.error("Sync to Sheets failed:", err);
      });
    }

    // ---------- apiClient (local mock, future API layer) --------------------
    const apiClient = {
      async loginWithLocalProfile() {
        const profile = getProfile();
        return {
          access_token: "local-dev-token",
          employee: {
            id: profile.employee_id || profile.client_id || ("local-" + Math.random().toString(36).slice(2)),
            first_name: profile.firstName || "Fname",
            last_name: profile.lastName || "Lname",
            preferred_name: profile.commonName || profile.firstName || "Fname",
            home_location_id: profile.location === "Other" ? "other" : "kyle",
            current_location_id: profile.location === "Other" ? "other" : "kyle",
            roles: ["Expo"],
            app_role: "employee"
          }
        };
      },

      async getModules({ locationId = "kyle", role = "Expo" } = {}) {
        // For now, ignore location/role filters and just return the local MODULES array.
        return MODULES.slice();
      },

      async postEvent(eventPayload) {
        // For now, route MODULE_COMPLETED events to the existing Sheets sync.
        try {
          if (eventPayload && eventPayload.type === "MODULE_COMPLETED") {
            const module = MODULES.find((m) => m.id === eventPayload.module_id);
            if (module) {
              const pct = typeof eventPayload.completion_pct === "number"
                ? eventPayload.completion_pct
                : 0;
              syncCompletionToSheet(module, pct);
            }
          }
          return { status: "ok" };
        } catch (err) {
          console.error("apiClient.postEvent failed:", err);
          throw err;
        }
      }
    };

    // ---------- Toast -------------------------------------------------------
    const toastEl = document.getElementById("toast");
    let toastTimeoutId = null;

    function showToast(message) {
      toastEl.textContent = message;
      toastEl.classList.add("show");
      if (toastTimeoutId) {
        clearTimeout(toastTimeoutId);
      }
      toastTimeoutId = setTimeout(() => {
        toastEl.classList.remove("show");
      }, 3200);
    }

    // ---------- Views & Nav -------------------------------------------------
    const views = {
      home: document.getElementById("view-home"),
      modules: document.getElementById("view-modules"),
      moduleDetail: document.getElementById("view-module-detail"),
      settings: document.getElementById("view-settings"),
      assigned: document.getElementById("view-assigned")
    };

    const headerTitle = document.getElementById("headerTitle");
    const backButton = document.getElementById("backButton");

    let currentView = "home";
    let lastView = "home";

    function updateBackButton() {
      if (
        currentView === "settings" ||
        currentView === "assigned" ||
        currentView === "moduleDetail"
      ) {
        backButton.style.display = "inline-flex";
      } else {
        backButton.style.display = "none";
      }
    }

    function setView(viewKey, viaBack = false) {
      if (!viaBack && viewKey !== currentView) {
        lastView = currentView;
      }
      currentView = viewKey;
      Object.values(views).forEach((v) => v.classList.remove("active"));
      const view = views[viewKey];
      if (view) view.classList.add("active");

      // Header title stays "Texican Logo" for all views.
      if (headerTitle) {
        headerTitle.textContent = "Texican Logo";
      }

      document
        .querySelectorAll(".tab-btn")
        .forEach((btn) => btn.classList.remove("active"));

      if (viewKey === "home") {
        document
          .querySelector('.tab-btn[data-tab="home"]')
          .classList.add("active");
      } else if (viewKey === "modules" || viewKey === "moduleDetail") {
        document
          .querySelector('.tab-btn[data-tab="modules"]')
          .classList.add("active");
      }

      updateBackButton();
    }

    backButton.addEventListener("click", () => {
      const target = lastView || "home";
      setView(target, true);
      if (target === "home") {
        renderHome();
      } else if (target === "modules") {
        renderModulesList();
      } else if (target === "assigned") {
        renderAssignedView();
      }
    });

    // ---------- Helpers: Assigned & Progress --------------------------------
    function getAssignedModules() {
      const profile = getProfile();
      const modulesSource = (allModules && allModules.length) ? allModules : MODULES;
      if (profile.role === "Expo") {
        return modulesSource.filter((m) => m.role === "Expo");
      }
      return [];
    }

    function getCompletedAssignedCount() {
      const assigned = getAssignedModules();
      return assigned.filter((m) => !!state.completed[m.id]).length;
    }

    // ---------- Accordion Rendering ----------------------------------------
    function renderAssignedAccordion(containerEl, modules) {
      containerEl.innerHTML = "";
      if (!modules || modules.length === 0) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "No training modules configured.";
        containerEl.appendChild(empty);
        return;
      }

      const accordion = document.createElement("div");
      accordion.className = "accordion";

      // Group by category
      const categories = {};
      modules.forEach((m) => {
        if (!categories[m.category]) categories[m.category] = [];
        categories[m.category].push(m);
      });

      const catKeys = Object.keys(categories).sort();
      catKeys.forEach((cat, idx) => {
        const item = document.createElement("div");
        item.className = "accordion-item";
        if (idx === 0) item.classList.add("open");

        const header = document.createElement("button");
        header.type = "button";
        header.className = "accordion-header";

        const left = document.createElement("div");
        const title = document.createElement("span");
        title.className = "accordion-title";
        title.textContent = cat;
        left.appendChild(title);

        const mods = categories[cat];
        const completedCount = mods.filter((m) => !!state.completed[m.id]).length;
        const meta = document.createElement("span");
        meta.className = "accordion-meta";
        meta.textContent = `${completedCount}/${mods.length} complete`;
        left.appendChild(meta);

        const chevron = document.createElement("span");
        chevron.className = "accordion-chevron";
        chevron.textContent = "▾";

        header.appendChild(left);
        header.appendChild(chevron);

        const body = document.createElement("div");
        body.className = "accordion-body";

        const list = document.createElement("div");
        list.className = "list";

        mods.forEach((m) => {
          const completed = !!state.completed[m.id];
          const itemRow = document.createElement("div");
          itemRow.className =
            "list-item " +
            (completed ? "status-complete" : "status-required");
          itemRow.onclick = () => openModuleDetail(m.id);
          const metaText = completed ? "Complete" : "Required";
          itemRow.innerHTML = `<span class="label">${m.title}</span><span class="meta">${metaText}</span>`;
          list.appendChild(itemRow);
        });

        body.appendChild(list);

        header.addEventListener("click", () => {
          item.classList.toggle("open");
        });

        item.appendChild(header);
        item.appendChild(body);
        accordion.appendChild(item);
      });

      containerEl.appendChild(accordion);
    }

    // ---------- Home Rendering ---------------------------------------------
    function renderHome() {
      const assigned = getAssignedModules();
      const completedCount = getCompletedAssignedCount();

      const label = document.getElementById("progressLabel");
      label.textContent = `${completedCount} / ${assigned.length} Modules Completed`;

      const progressFill = document.getElementById("progressFill");
      const pct =
        assigned.length === 0 ? 0 : (completedCount / assigned.length) * 100;
      progressFill.style.width = pct + "%";

      const alertContainer = document.getElementById("homeAlertContainer");
      alertContainer.innerHTML = "";
      const alert = document.createElement("div");
      alert.className = "alert";
      if (assigned.length === 0) {
        alert.innerHTML =
          "<div><strong>No training modules yet.</strong><span class='muted'>Your training plan has not been configured.</span></div>";
      } else if (completedCount < assigned.length) {
        const remaining = assigned.length - completedCount;
        alert.innerHTML = `<div><strong>Training in progress.</strong>You have ${remaining} required module${
          remaining !== 1 ? "s" : ""
        } left to complete.</div>`;
      } else {
        alert.classList.add("complete");
        alert.innerHTML =
          "<div><strong>You have completed all required training.</strong><span class='muted'>Great job. Check back for new modules.</span></div>";
      }
      alertContainer.appendChild(alert);

      const homeAssignedAccordion = document.getElementById("homeAssignedAccordion");
      renderAssignedAccordion(homeAssignedAccordion, assigned);
    }

    // ---------- Modules View Rendering -------------------------------------
    function renderModulesList() {
      const container = document.getElementById("modulesList");
      container.innerHTML = "";

      const accordion = document.createElement("div");
      accordion.className = "accordion";

      const modulesSource = (allModules && allModules.length) ? allModules : MODULES;
      const expoModules = modulesSource.filter((m) => m.role === "Expo");

      ROLES.forEach((roleObj) => {
        const item = document.createElement("div");
        item.className = "accordion-item";
        if (roleObj.id === "Expo") {
          item.classList.add("open");
        }

        const header = document.createElement("button");
        header.type = "button";
        header.className = "accordion-header";

        const left = document.createElement("div");
        const title = document.createElement("span");
        title.className = "accordion-title";
        title.textContent = roleObj.label;
        left.appendChild(title);

        const meta = document.createElement("span");
        meta.className = "accordion-meta";

        if (roleObj.id === "Expo") {
          const completedCount = expoModules.filter((m) => !!state.completed[m.id]).length;
          meta.textContent = `${completedCount}/${expoModules.length} complete • Available now`;
        } else {
          meta.textContent = "Coming soon";
        }
        left.appendChild(meta);

        const chevron = document.createElement("span");
        chevron.className = "accordion-chevron";
        chevron.textContent = "▾";

        header.appendChild(left);
        header.appendChild(chevron);

        const body = document.createElement("div");
        body.className = "accordion-body";

        if (roleObj.id === "Expo") {
          if (expoModules.length === 0) {
            const empty = document.createElement("div");
            empty.className = "empty-state";
            empty.textContent = "No Expo training modules configured.";
            body.appendChild(empty);
          } else {
            // Group by category inside Expo
            const categories = {};
            expoModules.forEach((m) => {
              if (!categories[m.category]) categories[m.category] = [];
              categories[m.category].push(m);
            });

            Object.keys(categories)
              .sort()
              .forEach((cat) => {
                const catLabel = document.createElement("p");
                catLabel.textContent = cat;
                catLabel.className = "muted";
                catLabel.style.fontSize = "0.78rem";
                catLabel.style.margin = "0.1rem 0 0.1rem";
                body.appendChild(catLabel);

                const list = document.createElement("div");
                list.className = "list";

                categories[cat].forEach((m) => {
                  const completed = !!state.completed[m.id];
                  const itemRow = document.createElement("div");
                  itemRow.className =
                    "list-item " +
                    (completed ? "status-complete" : "status-required");
                  itemRow.onclick = () => openModuleDetail(m.id);
                  const metaText = completed ? "Complete" : "Required";
                  itemRow.innerHTML = `<span class="label">${m.title}</span><span class="meta">${metaText}</span>`;
                  list.appendChild(itemRow);
                });

                body.appendChild(list);
              });
          }
        } else {
          const coming = document.createElement("div");
          coming.className = "empty-state";
          coming.textContent = `${roleObj.label} training modules are coming soon.`;
          body.appendChild(coming);
        }

        header.addEventListener("click", () => {
          item.classList.toggle("open");
        });

        item.appendChild(header);
        item.appendChild(body);
        accordion.appendChild(item);
      });

      container.appendChild(accordion);
    }

    // ---------- Module Detail & Completion Gating ---------------------------
    let currentModuleId = null;
    let currentCarouselIndex = 0;
    let currentCarouselImages = [];

    function updateCarouselDisplay() {
      const mainImg = document.getElementById("moduleMainImage");
      const counterEl = document.getElementById("moduleCarouselCounter");
      if (!mainImg || !counterEl || !currentCarouselImages.length) return;
      mainImg.src = currentCarouselImages[currentCarouselIndex];
      counterEl.textContent = `${currentCarouselIndex + 1} / ${currentCarouselImages.length}`;
    }

    function renderModuleImages(module) {
      const imgContainer = document.getElementById("detailImageContainer");
      imgContainer.innerHTML = "";

      const wrapper = document.createElement("div");
      wrapper.className = "module-image-wrapper";

      const main = document.createElement("div");
      main.className = "module-image-main";

      const hasImages = Array.isArray(module.images) && module.images.length > 0;

      if (hasImages) {
        const img = document.createElement("img");
        img.id = "moduleMainImage";
        img.src = module.images[0];
        img.alt = module.title;
        main.appendChild(img);
      } else {
        const placeholder = document.createElement("div");
        placeholder.className = "module-image-placeholder";
        placeholder.textContent = "Training image coming soon.";
        main.appendChild(placeholder);
      }

      wrapper.appendChild(main);

      if (hasImages) {
        const controls = document.createElement("div");
        controls.className = "module-carousel-controls";

        const prevBtn = document.createElement("button");
        prevBtn.type = "button";
        prevBtn.className = "module-carousel-btn";
        prevBtn.textContent = "◀ Prev";

        const counter = document.createElement("div");
        counter.className = "module-carousel-counter";
        counter.id = "moduleCarouselCounter";
        counter.textContent = `1 / ${module.images.length}`;

        const nextBtn = document.createElement("button");
        nextBtn.type = "button";
        nextBtn.className = "module-carousel-btn";
        nextBtn.textContent = "Next ▶";

        prevBtn.addEventListener("click", () => {
          if (!currentCarouselImages.length) return;
          currentCarouselIndex =
            (currentCarouselIndex - 1 + currentCarouselImages.length) %
            currentCarouselImages.length;
          updateCarouselDisplay();
        });

        nextBtn.addEventListener("click", () => {
          if (!currentCarouselImages.length) return;
          currentCarouselIndex =
            (currentCarouselIndex + 1) % currentCarouselImages.length;
          updateCarouselDisplay();
        });

        controls.appendChild(prevBtn);
        controls.appendChild(counter);
        controls.appendChild(nextBtn);
        wrapper.appendChild(controls);
      }

      imgContainer.appendChild(wrapper);

      currentCarouselImages = hasImages ? module.images.slice() : [];
      currentCarouselIndex = 0;
    }

    function updateCompleteButtonState() {
      const btn = document.getElementById("completeModuleBtn");
      btn.classList.remove("completed");
      if (!currentModuleId) {
        btn.disabled = true;
        return;
      }

      const completedAlready = !!state.completed[currentModuleId];
      if (completedAlready) {
        btn.disabled = true;
        btn.textContent = "Module Completed";
        btn.classList.add("completed");
        return;
      }

      const checkboxes = document.querySelectorAll(
        "#detailSteps input[type='checkbox']"
      );
      if (checkboxes.length === 0) {
        btn.disabled = true;
        btn.textContent = "Mark Module Complete";
        return;
      }

      const allChecked = Array.from(checkboxes).every((cb) => cb.checked);
      btn.disabled = !allChecked;
      btn.textContent = allChecked
        ? "Mark Module Complete"
        : "Check all steps to complete";
    }

    function openModuleDetail(id) {
      const modulesSource = (allModules && allModules.length) ? allModules : MODULES;
      const module = modulesSource.find((m) => m.id === id);
      if (!module) return;

      currentModuleId = id;
      document.getElementById("detailCategoryPill").textContent =
        module.category;
      document.getElementById("detailTitle").textContent = module.title;
      document.getElementById("detailDescription").textContent =
        module.description;

      renderModuleImages(module);

      const stepsContainer = document.getElementById("detailSteps");
      stepsContainer.innerHTML = "";
      module.steps.forEach((step, index) => {
        const row = document.createElement("div");
        row.className = "step-row";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.dataset.stepIndex = index;

        const textSpan = document.createElement("span");
        textSpan.textContent = step;

        checkbox.addEventListener("change", updateCompleteButtonState);

        row.addEventListener("click", (e) => {
          if (e.target === checkbox) return;
          checkbox.checked = !checkbox.checked;
          updateCompleteButtonState();
        });

        row.appendChild(checkbox);
        row.appendChild(textSpan);
        stepsContainer.appendChild(row);
      });

      const completed = !!state.completed[id];
      const hint = document.getElementById("detailHint");
      hint.textContent = completed
        ? "This module is marked complete. You can review steps any time."
        : "Work through each step, then check all boxes to enable completion.";

      const btn = document.getElementById("completeModuleBtn");
      btn.disabled = true;
      btn.classList.remove("completed");
      if (completed) {
        btn.disabled = true;
        btn.textContent = "Module Completed";
        btn.classList.add("completed");
      } else {
        btn.textContent = "Check all steps to complete";
      }

      updateCompleteButtonState();
      setView("moduleDetail");
    }

    // ---------- Quiz Logic --------------------------------------------------
    const quizOverlay = document.getElementById("quizOverlay");
    const quizQuestionEl = document.getElementById("quizQuestion");
    const quizOptionsEl = document.getElementById("quizOptions");
    const quizNumberInput = document.getElementById("quizNumberInput");
    const quizErrorEl = document.getElementById("quizError");
    const quizSubmitBtn = document.getElementById("quizSubmitBtn");
    const quizCancelBtn = document.getElementById("quizCancelBtn");

    let quizState = {
      moduleId: null,
      type: null,         // "mc" | "number"
      correct: null       // string or number
    };

    function shuffleArray(arr) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function buildQuizForModule(module) {
      const steps = Array.isArray(module.steps) ? module.steps.slice() : [];

      // Fallback: if no steps, use a simple "how many steps" pattern with 0.
      if (!steps.length) {
        return {
          type: "number",
          question: "How many steps are listed in this module?",
          correct: 0,
          options: null
        };
      }

      const modulesSource = (allModules && allModules.length) ? allModules : MODULES;
      const moduleIndex = modulesSource.findIndex((m) => m.id === module.id);
      const useMultipleChoice = moduleIndex % 2 === 0; // even = MC, odd = numeric

      if (useMultipleChoice) {
        // Multiple choice: "Which of the following is a step in this module?"
        const correctStep =
          steps[Math.floor(Math.random() * steps.length)];

        const otherSteps = steps.filter((s) => s !== correctStep);
        const distractors = shuffleArray(otherSteps).slice(0, 3);
        const options = shuffleArray([correctStep, ...distractors]);

        return {
          type: "mc",
          question: "Which of the following is one of the steps in this module?",
          correct: correctStep,
          options
        };
      } else {
        // Numeric: "How many steps are in this module?"
        return {
          type: "number",
          question: "How many steps are in this module?",
          correct: steps.length,
          options: null
        };
      }
    }

    function openQuizForModule(module) {
      const quiz = buildQuizForModule(module);
      quizState.moduleId = module.id;
      quizState.type = quiz.type;
      quizState.correct = quiz.correct;
      quizErrorEl.textContent = "";

      quizQuestionEl.textContent = quiz.question;

      quizOptionsEl.innerHTML = "";
      quizNumberInput.style.display = "none";
      quizNumberInput.value = "";

      if (quiz.type === "mc" && quiz.options) {
        quizOptionsEl.style.display = "flex";
        quiz.options.forEach((opt, idx) => {
          const row = document.createElement("label");
          row.className = "quiz-option-row";

          const input = document.createElement("input");
          input.type = "radio";
          input.name = "quiz-option";
          input.value = opt;
          if (idx === 0) input.checked = true;

          const span = document.createElement("span");
          span.textContent = opt;

          row.appendChild(input);
          row.appendChild(span);
          quizOptionsEl.appendChild(row);
        });
      } else {
        quizOptionsEl.style.display = "none";
        quizNumberInput.style.display = "block";
      }

      quizOverlay.classList.add("show");
      quizOverlay.setAttribute("aria-hidden", "false");
    }

    function closeQuiz() {
      quizOverlay.classList.remove("show");
      quizOverlay.setAttribute("aria-hidden", "true");
      quizErrorEl.textContent = "";
      quizState.moduleId = null;
      quizState.type = null;
      quizState.correct = null;
    }

    quizCancelBtn.addEventListener("click", () => {
      // User can cancel, but module won't be marked complete.
      closeQuiz();
    });

    quizSubmitBtn.addEventListener("click", () => {
      if (!quizState.moduleId || !quizState.type) return;

      if (quizState.type === "mc") {
        const selected = document.querySelector(
          '#quizOptions input[name="quiz-option"]:checked'
        );
        if (!selected) {
          quizErrorEl.textContent = "Please select an answer.";
          return;
        }
        const value = selected.value;
        if (value === quizState.correct) {
          const modulesSource = (allModules && allModules.length) ? allModules : MODULES;
          const module = modulesSource.find((m) => m.id === quizState.moduleId);
          closeQuiz();
          if (module) finalizeModuleCompletion(module);
        } else {
          quizErrorEl.textContent = "Not quite. Try again.";
        }
      } else if (quizState.type === "number") {
        const raw = quizNumberInput.value;
        if (raw === "") {
          quizErrorEl.textContent = "Enter a number to continue.";
          return;
        }
        const num = parseInt(raw, 10);
        if (Number.isNaN(num)) {
          quizErrorEl.textContent = "That doesn't look like a number. Try again.";
          return;
        }
        if (num === quizState.correct) {
          const modulesSource = (allModules && allModules.length) ? allModules : MODULES;
          const module = modulesSource.find((m) => m.id === quizState.moduleId);
          closeQuiz();
          if (module) finalizeModuleCompletion(module);
        } else {
          quizErrorEl.textContent = "That's not the right number of steps. Try again.";
        }
      }
    });

    // ---------- Finalize Completion (after quiz success) --------------------
    function finalizeModuleCompletion(module) {
      if (!module) return;

      state.completed[module.id] = true;
      saveState();

      renderHome();
      renderModulesList();

      const assigned = getAssignedModules();
      const completedCount = getCompletedAssignedCount();
      const pct =
        assigned.length === 0
          ? 0
          : Math.round((completedCount / assigned.length) * 100);

      // Send event via apiClient (which currently routes to Sheets)
      apiClient
        .postEvent({
          type: "MODULE_COMPLETED",
          module_id: module.id,
          completion_pct: pct
        })
        .catch((err) => {
          console.error("Event post failed:", err);
        });

      const btn = document.getElementById("completeModuleBtn");
      if (btn) {
        btn.classList.add("completed");
        btn.textContent = "Module Completed";
        btn.disabled = true;
      }

      setView("home");
      showToast(
        `Completed: ${module.title} • ${pct}% of required training done`
      );
    }

    document
      .getElementById("completeModuleBtn")
      .addEventListener("click", () => {
        if (!currentModuleId) return;
        const btn = document.getElementById("completeModuleBtn");
        if (btn.disabled) return;

        const modulesSource = (allModules && allModules.length) ? allModules : MODULES;
        const module = modulesSource.find((m) => m.id === currentModuleId);
        if (!module) return;

        // Instead of directly completing, open the quiz.
        openQuizForModule(module);
      });

    // ---------- Assigned View (if used) -------------------------------------
    function renderAssignedView() {
      const container = document.getElementById("assignedAccordion");
      const assigned = getAssignedModules();
      renderAssignedAccordion(container, assigned);
    }

    // ---------- Settings: Profile Editing -----------------------------------
    document
      .getElementById("profileFirstNameRow")
      .addEventListener("click", () => {
        const current = getProfile().firstName;
        const value = prompt("Enter your first name", current || "");
        if (value && value.trim()) {
          localStorage.setItem(PROFILE_FIRST_NAME_KEY, value.trim());
          refreshHeaderFromProfile();
          updateSettingsProfileUI();
        }
      });

    document
      .getElementById("profileLastNameRow")
      .addEventListener("click", () => {
        const current = getProfile().lastName;
        const value = prompt("Enter your last name", current || "");
        if (value && value.trim()) {
          localStorage.setItem(PROFILE_LAST_NAME_KEY, value.trim());
          refreshHeaderFromProfile();
          updateSettingsProfileUI();
        }
      });

    document
      .getElementById("profileCommonNameRow")
      .addEventListener("click", () => {
        const current = getProfile().commonName;
        const value = prompt(
          "Enter your common name (optional)",
          current || ""
        );
        if (value !== null) {
          localStorage.setItem(PROFILE_COMMON_NAME_KEY, value.trim());
          refreshHeaderFromProfile();
          updateSettingsProfileUI();
        }
      });

    document
      .getElementById("profileEmployeeIdRow")
      .addEventListener("click", () => {
        const current = getProfile().employee_id;
        const value = prompt(
          "Enter your employee ID (optional)",
          current || ""
        );
        if (value !== null) {
          localStorage.setItem(PROFILE_EMPLOYEE_ID_KEY, value.trim());
          updateSettingsProfileUI();
        }
      });

    document
      .getElementById("profileLocationSelect")
      .addEventListener("change", (e) => {
        const value = e.target.value === "Other" ? "Other" : "Kyle";
        localStorage.setItem(PROFILE_LOCATION_KEY, value);
        updateSettingsProfileUI();
      });

    // ---------- Navigation Wiring -------------------------------------------
    document
      .querySelectorAll(".tab-btn")
      .forEach((btn) =>
        btn.addEventListener("click", () => {
          const tab = btn.dataset.tab;
          if (tab === "home") {
            setView("home");
            renderHome();
          } else if (tab === "modules") {
            setView("modules");
            renderModulesList();
          }
        })
      );

    document
      .getElementById("settingsButton")
      .addEventListener("click", () => {
        updateSettingsProfileUI();
        setView("settings");
      });

    // ---------- Initial Render via initApp ----------------------------------
    (async function initApp() {
      try {
        const session = await apiClient.loginWithLocalProfile();
        currentEmployee = session.employee || null;
      } catch (e) {
        console.error("Login simulation failed:", e);
      }

      refreshHeaderFromProfile();
      updateSettingsProfileUI();

      try {
        const modulesFromApi = await apiClient.getModules({
          locationId:
            currentEmployee && currentEmployee.current_location_id
              ? currentEmployee.current_location_id
              : "kyle",
          role: "Expo"
        });
        if (Array.isArray(modulesFromApi) && modulesFromApi.length) {
          allModules = modulesFromApi;
        } else {
          allModules = MODULES.slice();
        }
      } catch (e) {
        console.error(
          "Loading modules from apiClient failed, using local MODULES.",
          e
        );
        allModules = MODULES.slice();
      }

      renderHome();
      renderModulesList();
    })();
  </script>
</body>
</html>
