<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>RITA â€” Manager Console</title>

  <style>
    :root{
      --bg:#0b0c10; --panel:#11131a; --panel2:#0f1117;
      --text:#f2f4f8; --muted:rgba(242,244,248,.72);
      --stroke:rgba(255,255,255,.12); --accent:#3ee8c9; --danger:#ff5a5f;
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:16px; --pad:14px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    [data-theme="light"]{
      --bg:#f6f7fb; --panel:#ffffff; --panel2:#fbfcff;
      --text:#0b1020; --muted:rgba(11,16,32,.65);
      --stroke:rgba(11,16,32,.14); --accent:#0aa37f;
      --shadow:0 16px 40px rgba(20,25,40,.12);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(62,232,201,.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(62,232,201,.12), transparent 55%),
                  var(--bg);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: color-mix(in srgb, var(--bg) 75%, transparent);
      border-bottom:1px solid var(--stroke);
    }
    .wrap{ max-width:1200px; margin:0 auto; padding:16px; }
    .topbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .title .sub{ font-size:12px; color:var(--muted); font-family:var(--mono); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{
      appearance:none; border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      color:var(--text);
      padding:10px 12px; border-radius:12px; cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      font-weight:650; font-size:13px;
    }
    .btn:hover{ border-color: color-mix(in srgb, var(--accent) 40%, var(--stroke)); }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--stroke));
      background: color-mix(in srgb, var(--accent) 14%, var(--panel));
    }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--stroke);
      padding:6px 10px; border-radius:999px;
      font-family:var(--mono);
    }

    main .grid{
      display:grid; grid-template-columns: 1.25fr .75fr; gap:12px;
      padding:16px; max-width:1200px; margin:0 auto;
    }
    @media (max-width: 980px){ main .grid{ grid-template-columns:1fr; } }

    .card{
      background: linear-gradient(180deg, color-mix(in srgb, var(--panel) 92%, transparent), var(--panel2));
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:var(--pad);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .card .hd h2{ margin:0; font-size:14px; letter-spacing:.2px; }
    .card .bd{ padding:var(--pad); }

    .kpi{ display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    @media (max-width:560px){ .kpi{ grid-template-columns:1fr; } }
    .kpi .box{
      border:1px solid var(--stroke);
      border-radius:14px; padding:12px;
      background: color-mix(in srgb, var(--panel) 88%, transparent);
    }
    .kpi .num{ font-size:20px; font-weight:850; }
    .kpi .lbl{ font-size:12px; color:var(--muted); margin-top:4px; }

    .list{ display:flex; flex-direction:column; gap:10px; }

    .item{
      border:1px solid var(--stroke);
      border-radius:14px; padding:12px;
      background: color-mix(in srgb, var(--panel) 88%, transparent);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .item .meta{ display:flex; flex-direction:column; gap:8px; min-width:260px; flex:1; }
    .item .meta .a{ font-weight:800; font-size:14px; }
    .item .meta .b{ font-size:12px; color:var(--muted); font-family:var(--mono); }
    .item .actions{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:10px; }
    .field label{ font-size:12px; color:var(--muted); }
    .field input,.field select,.field textarea{
      padding:10px 10px; border-radius:12px;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      color:var(--text); outline:none; font-size:13px;
    }
    .field textarea{ min-height:70px; resize:vertical; }

    .hr{ height:1px; background:var(--stroke); margin:12px 0; }
    .small{ font-size:12px; color:var(--muted); }
    .mono{ font-family:var(--mono); }

    .bar{
      width:100%;
      height:10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 75%, transparent);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      background: color-mix(in srgb, var(--accent) 60%, transparent);
      width:0%;
    }

    details{
      border:1px solid var(--stroke);
      border-radius:14px;
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      padding:10px 12px;
    }
    summary{
      cursor:pointer;
      font-weight:750;
      font-size:13px;
      list-style:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    summary::-webkit-details-marker{ display:none; }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--text);
      background: color-mix(in srgb, var(--panel) 84%, transparent);
      font-family: var(--mono);
    }
    .chip.ok{ border-color: color-mix(in srgb, var(--accent) 50%, var(--stroke)); }
    .chip.muted{ color: var(--muted); }

    /* Modal base */
    .modalBackdrop{
      position:fixed; inset:0; z-index:50;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px;
    }
    [data-theme="light"] .modalBackdrop{ background: rgba(15,18,30,.35); }

    .modal{
      width:min(920px,100%);
      border-radius:18px; border:1px solid var(--stroke);
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      box-shadow:0 30px 80px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal .mhd{
      padding:14px; border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modal .mbd{ padding:14px; }
    .modal .mft{
      padding:14px; border-top:1px solid var(--stroke);
      display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
    }

    /* Analytics tabs */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .tab{
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      font-weight:750;
      color:var(--muted);
    }
    .tab.active{
      color:var(--text);
      border-color: color-mix(in srgb, var(--accent) 45%, var(--stroke));
      background: color-mix(in srgb, var(--accent) 12%, var(--panel));
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border:1px solid var(--stroke);
      border-radius:14px;
      background: color-mix(in srgb, var(--panel) 86%, transparent);
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--stroke);
      font-size:12px;
      text-align:left;
      color:var(--text);
    }
    .table th{ color:var(--muted); font-family:var(--mono); font-weight:800; }
    .table tr:last-child td{ border-bottom:none; }

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: color-mix(in srgb, var(--panel) 92%, rgba(0,0,0,.15));
      border:1px solid var(--stroke);
      color:var(--text); padding:10px 12px; border-radius:999px;
      box-shadow:var(--shadow);
      display:none; z-index:99; font-size:13px;
      max-width:calc(100vw - 30px);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="title">
        <h1>RITA â€” Manager Console</h1>
        <div class="sub">Assignments â€¢ roles â€¢ completions â€¢ v<?= appVersion ?></div>
      </div>

      <div class="row">
        <span class="pill" id="statusPill">Loadingâ€¦</span>
        <button class="btn" id="themeBtn">ðŸŒ“ Theme</button>
        <button class="btn" id="analyticsBtn">ðŸ“Š Analytics</button>
        <button class="btn" id="seedBtn">Seed Data</button>
        <button class="btn primary" id="refreshBtn">Refresh</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">

    <!-- Manager console -->
    <section class="card">
      <div class="hd">
        <h2>Manager Console</h2>
        <button class="btn primary" id="assignBtn">+ Assign Training</button>
      </div>

      <div class="bd">
        <div class="kpi" id="kpis"></div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <div style="font-weight:850;">Assignments</div>
            <div class="small">Shows assignment progress + whoâ€™s assigned / completed.</div>
          </div>
          <div class="field" style="margin:0; width:min(260px, 100%);">
            <label>Filter</label>
            <select id="asgFilter">
              <option value="all">All assignments</option>
              <option value="open">Open</option>
              <option value="done">Done</option>
            </select>
          </div>
        </div>

        <div class="list" id="assignmentsList" style="margin-top:10px;"></div>

        <div class="hr"></div>
        <div class="small mono" id="diagBox">â€”</div>
      </div>
    </section>

    <!-- Employee view (still useful for testing) -->
    <section class="card">
      <div class="hd">
        <h2>Employee View</h2>
        <div class="field" style="margin:0; width:min(320px, 100%);">
          <label>Pick an employee</label>
          <select id="employeeSelect"></select>
        </div>
      </div>

      <div class="bd">
        <div class="small">Simulates an employee: Start / Complete assigned modules.</div>
        <div class="hr"></div>
        <div class="list" id="employeeAssignments"></div>
      </div>
    </section>

  </div>
</main>

<!-- Assignment modal -->
<div class="modalBackdrop" id="assignBackdrop">
  <div class="modal">
    <div class="mhd">
      <strong>Create Assignment</strong>
      <button class="btn" id="closeAssignBtn">âœ•</button>
    </div>

    <div class="mbd">
      <div class="field">
        <label>Module</label>
        <select id="moduleSelect"></select>
      </div>

      <div class="field">
        <label>Assign to</label>
        <select id="assigneeType">
          <option value="ALL">All Employees</option>
          <option value="ROLE">Only Employees in Role</option>
          <option value="SELECTED">Selected Employees</option>
        </select>
      </div>

      <div id="rolePickWrap" style="display:none;">
        <div class="field">
          <label>Target role</label>
          <select id="targetRoleId"></select>
        </div>
      </div>

      <div id="selectedPickWrap" style="display:none;">
        <div class="field">
          <label>Select employees</label>
          <select id="selectedEmployeesMulti" multiple size="6"></select>
          <div class="small">Tip: hold Ctrl/âŒ˜ to multi-select. (Weâ€™ll store IDs behind the scenes.)</div>
        </div>
      </div>

      <div class="field">
        <label>Due date (optional)</label>
        <input id="dueDateISO" placeholder="2026-01-15" />
      </div>

      <div class="field">
        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="Example: Complete before Friday shift."></textarea>
      </div>

      <div class="small">Created by: <span class="mono" id="createdBy">manager_test</span></div>
    </div>

    <div class="mft">
      <button class="btn" id="cancelAssignBtn">Cancel</button>
      <button class="btn primary" id="createAssignmentBtn">Create Assignment</button>
    </div>
  </div>
</div>

<!-- Analytics modal -->
<div class="modalBackdrop" id="analyticsBackdrop">
  <div class="modal">
    <div class="mhd">
      <strong>Analytics</strong>
      <button class="btn" id="closeAnalyticsBtn">âœ•</button>
    </div>

    <div class="mbd">
      <div class="tabs">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="module">Module Detail</button>
        <button class="tab" data-tab="activity">Recent Activity</button>
      </div>

      <!-- Overview -->
      <div id="tab-overview">
        <div class="small" style="margin-bottom:10px;">
          Completion % by module (based on the <b>latest assignment per module</b>).
        </div>
        <canvas id="moduleChart" width="860" height="260" style="width:100%; border:1px solid var(--stroke); border-radius:14px;"></canvas>
        <div class="hr"></div>
        <div id="overviewTable"></div>
      </div>

      <!-- Module Detail -->
      <div id="tab-module" style="display:none;">
        <div class="field">
          <label>Select module</label>
          <select id="analyticsModuleSelect"></select>
        </div>

        <div id="moduleDetailPanel"></div>
      </div>

      <!-- Activity -->
      <div id="tab-activity" style="display:none;">
        <div class="small" style="margin-bottom:10px;">Latest completions (most recent first).</div>
        <div id="activityTable"></div>
      </div>
    </div>

    <div class="mft">
      <button class="btn" id="closeAnalyticsBtn2">Close</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ---- Theme ----
  const THEME_KEY = "rita_theme";
  function applyTheme(theme){ document.documentElement.setAttribute("data-theme", theme); localStorage.setItem(THEME_KEY, theme); }
  function toggleTheme(){
    const cur = document.documentElement.getAttribute("data-theme") || "dark";
    applyTheme(cur === "dark" ? "light" : "dark");
    toast(`Theme: ${document.documentElement.getAttribute("data-theme")}`);
    renderChart(); // re-render for contrast
  }
  (function initTheme(){ applyTheme(localStorage.getItem(THEME_KEY) || "dark"); })();

  // ---- google.script.run API wrapper (NO CORS) ----
  function api(action, data = {}) {
    return new Promise((resolve) => {
      if (!(window.google && google.script && google.script.run)) {
        resolve({ ok:false, error:"google.script.run not available. Open via deployed Web App." });
        return;
      }
      google.script.run
        .withSuccessHandler((res) => resolve(res))
        .withFailureHandler((err) => resolve({ ok:false, error: (err && err.message) ? err.message : String(err) }))
        .api(action, data);
    });
  }

  // ---- State ----
  let SNAP = null;
  let lastSeedCounts = null;
  const $ = (id) => document.getElementById(id);

  // ---- UI helpers ----
  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=> t.style.display="none", 2400);
  }
  function setStatus(text){ $("statusPill").textContent = text; }
  function safeStr(x){ return (x === undefined || x === null) ? "" : String(x); }

  // ---- Data helpers ----
  function employeeMap(){
    const m = new Map();
    (SNAP.employees||[]).forEach(e => m.set(String(e.employeeId), e));
    return m;
  }
  function moduleMap(){
    const m = new Map();
    (SNAP.modules||[]).forEach(mod => m.set(String(mod.moduleId), mod));
    return m;
  }
  function roleNameById(roleId){
    const r = (SNAP.roles||[]).find(x => safeStr(x.roleId) === safeStr(roleId));
    return r ? r.roleName : "";
  }
  function parseEmployeesFromCSV(csv){
    return safeStr(csv).split(",").map(s=>s.trim()).filter(Boolean);
  }

  function completionsMap(){
    // key = employeeId::assignmentId
    const m = new Map();
    (SNAP.completions||[]).forEach(c => {
      m.set(`${c.employeeId}::${c.assignmentId}`, c);
    });
    return m;
  }

  function computeTargets(assignment){
    const type = safeStr(assignment.assigneeType).toUpperCase();
    const employees = (SNAP.employees||[]).filter(e => !!e.active);

    if (type === "ALL") return employees.map(e => e.employeeId);

    if (type === "ROLE"){
      const rid = safeStr(assignment.targetRoleId).trim();
      return employees
        .filter(e => (e.roles||[]).includes(rid))
        .map(e => e.employeeId);
    }

    if (type === "SELECTED"){
      const ids = parseEmployeesFromCSV(assignment.selectedEmployeeIdsCSV);
      const set = new Set(ids);
      return employees.filter(e => set.has(e.employeeId)).map(e => e.employeeId);
    }

    return [];
  }

  function assignmentProgress(assignment){
    const targets = computeTargets(assignment);
    const cm = completionsMap();
    let done = 0;
    const completedIds = [];
    targets.forEach(empId => {
      const c = cm.get(`${empId}::${assignment.assignmentId}`);
      if (c && safeStr(c.status).toLowerCase() === "completed") {
        done++;
        completedIds.push(empId);
      }
    });
    return { done, total: targets.length, targets, completedIds };
  }

  function formatName(emp){
    if (!emp) return "Unknown";
    return `${emp.name} (${emp.employeeId})`;
  }

  function isDoneAssignment(a){
    const p = assignmentProgress(a);
    return (p.total > 0 && p.done === p.total);
  }

  function latestAssignmentPerModule(){
    // Choose the most recent assignment per module by createdAt (fallback to row order)
    const asgs = (SNAP.assignments || []).slice();
    asgs.sort((a,b) => String(b.createdAt||"").localeCompare(String(a.createdAt||"")));
    const map = new Map();
    for (const a of asgs){
      if (!map.has(a.moduleId)) map.set(a.moduleId, a);
    }
    return map; // moduleId -> assignment
  }

  // ---- Render: KPIs ----
  function renderKpis(){
    const emps = (SNAP.employees||[]).filter(e => !!e.active);
    const asgs = SNAP.assignments || [];
    const comps = SNAP.completions || [];

    const totalTargets = asgs.reduce((sum, a) => sum + computeTargets(a).length, 0);
    const completed = comps.filter(c => safeStr(c.status).toLowerCase() === "completed").length;

    $("kpis").innerHTML = [
      { num: emps.length, lbl: "Active Employees" },
      { num: asgs.length, lbl: "Assignments" },
      { num: `${completed}/${totalTargets || 0}`, lbl: "Completions (count/targets)" }
    ].map(b => `
      <div class="box">
        <div class="num">${b.num}</div>
        <div class="lbl">${b.lbl}</div>
      </div>
    `).join("");
  }

  // ---- Render: Employee Picker ----
  function renderEmployeePicker(){
    const sel = $("employeeSelect");
    sel.innerHTML = "";
    const emps = (SNAP.employees||[]).filter(e => !!e.active);

    if (!emps.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No employees (seed data)";
      sel.appendChild(opt);
      return;
    }

    emps.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e.employeeId;
      opt.textContent = `${e.name} (${e.employeeId}) â€” ${e.location || "â€”"}`;
      sel.appendChild(opt);
    });

    const saved = localStorage.getItem("rita_emp") || emps[0].employeeId;
    if (saved && emps.some(e => e.employeeId === saved)) sel.value = saved;
  }

  // ---- Render: Assignment Create Modal pickers ----
  function renderModulePicker(){
    const sel = $("moduleSelect");
    sel.innerHTML = "";
    const mods = (SNAP.modules || []).filter(m => !!m.active);

    if (!mods.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No modules (seed data)";
      sel.appendChild(opt);
      return;
    }

    mods.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.moduleId;
      const role = safeStr(m.roleId) ? ` â€¢ Role: ${roleNameById(m.roleId)}` : "";
      opt.textContent = `${m.title}${role} â€¢ v${safeStr(m.version) || "1.0"}`;
      sel.appendChild(opt);
    });
  }

  function renderRolePicker(){
    const sel = $("targetRoleId");
    sel.innerHTML = "";
    const roles = SNAP.roles || [];

    if (!roles.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No roles (seed data)";
      sel.appendChild(opt);
      return;
    }

    roles.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.roleId;
      opt.textContent = `${r.roleName} (${r.roleId})`;
      sel.appendChild(opt);
    });
  }

  function renderSelectedEmployeesMulti(){
    const sel = $("selectedEmployeesMulti");
    sel.innerHTML = "";
    const emps = (SNAP.employees||[]).filter(e => !!e.active);
    emps.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e.employeeId;
      opt.textContent = `${e.name} (${e.employeeId})`;
      sel.appendChild(opt);
    });
  }

  // ---- Render: Assignments list (manager-friendly) ----
  function renderAssignments(){
    const list = $("assignmentsList");
    const filter = $("asgFilter").value;

    const mm = moduleMap();
    const em = employeeMap();

    const asgs = (SNAP.assignments || []).slice().reverse();

    const items = asgs.map(a => {
      const mod = mm.get(String(a.moduleId));
      const p = assignmentProgress(a);
      const done = (p.total > 0 && p.done === p.total);

      if (filter === "open" && done) return null;
      if (filter === "done" && !done) return null;

      const percent = (p.total ? Math.round((p.done / p.total) * 100) : 0);

      const type = safeStr(a.assigneeType).toUpperCase();
      const typeLabel =
        type === "ALL" ? "All employees" :
        type === "ROLE" ? `Role: ${roleNameById(a.targetRoleId)}` :
        type === "SELECTED" ? "Selected employees" : type;

      const assignedNames = p.targets.map(id => formatName(em.get(String(id))));
      const completedSet = new Set(p.completedIds.map(String));
      const completedNames = p.targets
        .filter(id => completedSet.has(String(id)))
        .map(id => formatName(em.get(String(id))));

      const due = safeStr(a.dueDateISO).trim();

      return `
        <div class="item">
          <div class="meta">
            <div class="a">${mod ? mod.title : a.moduleId}</div>
            <div class="b">
              ${typeLabel} â€¢ Progress: ${p.done}/${p.total} (${percent}%)
              ${due ? " â€¢ Due: " + due : ""}
            </div>

            <div class="bar" aria-label="progress"><div style="width:${percent}%"></div></div>

            <details>
              <summary>
                Assigned (${assignedNames.length})
                <span class="small mono">${a.assignmentId}</span>
              </summary>
              <div class="chips">
                ${assignedNames.length
                  ? assignedNames.map(n => `<span class="chip muted">${n}</span>`).join("")
                  : `<span class="small">No targets for this assignment.</span>`
                }
              </div>
            </details>

            <details>
              <summary>
                Completed (${completedNames.length})
                <span class="small">${completedNames.length ? "âœ…" : ""}</span>
              </summary>
              <div class="chips">
                ${completedNames.length
                  ? completedNames.map(n => `<span class="chip ok">${n}</span>`).join("")
                  : `<span class="small">No completions yet.</span>`
                }
              </div>
            </details>

            ${a.notes ? `<div class="small">${a.notes}</div>` : ""}
          </div>

          <div class="actions">
            <button class="btn" data-action="openAnalytics" data-module="${a.moduleId}">View Module</button>
          </div>
        </div>
      `;
    }).filter(Boolean);

    list.innerHTML = items.length ? items.join("") : `<div class="small">No assignments yet. Create one.</div>`;

    list.querySelectorAll("button[data-action='openAnalytics']").forEach(btn => {
      btn.addEventListener("click", () => {
        const moduleId = btn.getAttribute("data-module");
        openAnalytics("module", moduleId);
      });
    });
  }

  // ---- Render: Employee assignments (test harness) ----
  function renderEmployeeAssignments(){
    const empId = $("employeeSelect").value;
    if (!empId){
      $("employeeAssignments").innerHTML = `<div class="small">Seed data to test employee assignments.</div>`;
      return;
    }
    localStorage.setItem("rita_emp", empId);

    const em = employeeMap();
    const mm = moduleMap();
    const cm = completionsMap();

    const asgs = (SNAP.assignments || []).slice().reverse();
    const assignedToEmp = asgs.filter(a => computeTargets(a).includes(empId));

    if (!assignedToEmp.length){
      $("employeeAssignments").innerHTML = `<div class="small">No assignments for this employee (yet).</div>`;
      return;
    }

    $("employeeAssignments").innerHTML = assignedToEmp.map(a => {
      const mod = mm.get(String(a.moduleId));
      const key = `${empId}::${a.assignmentId}`;
      const c = cm.get(key);
      const status = c ? safeStr(c.status).toLowerCase() : "not_started";
      const pretty = status === "completed" ? "âœ… Completed" : status === "in_progress" ? "ðŸŸ¡ In progress" : "âšª Not started";
      const due = safeStr(a.dueDateISO).trim();

      return `
        <div class="item">
          <div class="meta">
            <div class="a">${mod ? mod.title : a.moduleId}</div>
            <div class="b">Status: ${pretty}${due ? " â€¢ Due: " + due : ""}</div>
          </div>
          <div class="actions">
            <button class="btn" data-action="start" data-asg="${a.assignmentId}">Start</button>
            <button class="btn primary" data-action="complete" data-asg="${a.assignmentId}">Complete</button>
          </div>
        </div>
      `;
    }).join("");

    $("employeeAssignments").querySelectorAll("button[data-action]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const action = btn.getAttribute("data-action");
        const assignmentId = btn.getAttribute("data-asg");

        if (action === "start") {
          const r = await api("markCompletion", { employeeId: empId, assignmentId, status: "in_progress" });
          if (r.ok) { toast("Marked in progress"); await refresh(); }
          else toast(r.error || "Error");
        }

        if (action === "complete") {
          const score = prompt("Optional score (leave blank if none):", "");
          const r = await api("markCompletion", { employeeId: empId, assignmentId, status: "completed", score: (score ?? "") });
          if (r.ok) { toast("Completed âœ…"); await refresh(); }
          else toast(r.error || "Error");
        }
      });
    });
  }

  // ---- Diagnostics ----
  function renderDiagnostics(){
    const box = $("diagBox");
    if (!SNAP) { box.textContent = "â€”"; return; }
    const lines = [];
    lines.push(`Spreadsheet: ${SNAP.spreadsheet ? `${SNAP.spreadsheet.name} (${SNAP.spreadsheet.id})` : "â€”"}`);
    lines.push(`Rows â€” Roles:${(SNAP.roles||[]).length} Employees:${(SNAP.employees||[]).length} Modules:${(SNAP.modules||[]).length} Assignments:${(SNAP.assignments||[]).length} Completions:${(SNAP.completions||[]).length}`);
    if (lastSeedCounts) lines.push(`Last seed counts: ${JSON.stringify(lastSeedCounts)}`);
    box.textContent = lines.join(" â€¢ ");
  }

  // =========================
  // ANALYTICS (modal + tabs)
  // =========================
  function openBackdrop(id){ $(id).style.display = "flex"; }
  function closeBackdrop(id){ $(id).style.display = "none"; }

  function setAnalyticsTab(tabName){
    document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.getAttribute("data-tab") === tabName));
    $("tab-overview").style.display = tabName === "overview" ? "block" : "none";
    $("tab-module").style.display = tabName === "module" ? "block" : "none";
    $("tab-activity").style.display = tabName === "activity" ? "block" : "none";
  }

  function openAnalytics(tabName = "overview", moduleId = null){
    openBackdrop("analyticsBackdrop");
    setAnalyticsTab(tabName);
    renderAnalyticsPickers();
    renderOverview();
    renderActivity();
    if (moduleId){
      $("analyticsModuleSelect").value = moduleId;
      renderModuleDetail();
    }
    // defer chart render so canvas has correct layout
    setTimeout(renderChart, 30);
  }

  function renderAnalyticsPickers(){
    const sel = $("analyticsModuleSelect");
    sel.innerHTML = "";
    const mods = (SNAP.modules||[]).filter(m => !!m.active);

    mods.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.moduleId;
      opt.textContent = `${m.title}`;
      sel.appendChild(opt);
    });

    if (!sel.value && mods.length) sel.value = mods[0].moduleId;
  }

  function getModuleStatsFromLatestAssignments(){
    const mm = moduleMap();
    const em = employeeMap();

    const latestMap = latestAssignmentPerModule(); // moduleId -> assignment
    const rows = [];

    for (const [moduleId, asg] of latestMap.entries()){
      const mod = mm.get(String(moduleId));
      if (!mod) continue;

      const p = assignmentProgress(asg);
      const percent = p.total ? (p.done / p.total) * 100 : 0;

      // Assigned & completed names
      const completedSet = new Set(p.completedIds.map(String));
      const assignedNames = p.targets.map(id => formatName(em.get(String(id))));
      const completedNames = p.targets
        .filter(id => completedSet.has(String(id)))
        .map(id => formatName(em.get(String(id))));

      rows.push({
        moduleId,
        moduleTitle: mod.title,
        assignmentId: asg.assignmentId,
        done: p.done,
        total: p.total,
        percent,
        assignedNames,
        completedNames
      });
    }

    rows.sort((a,b) => b.percent - a.percent);
    return rows;
  }

  function renderOverview(){
    const rows = getModuleStatsFromLatestAssignments();

    const html = `
      <table class="table">
        <thead>
          <tr>
            <th>Module</th>
            <th>Completion</th>
            <th>Latest Assignment</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td><b>${r.moduleTitle}</b><div class="small mono">${r.moduleId}</div></td>
              <td>${Math.round(r.percent)}% <span class="small mono">(${r.done}/${r.total})</span></td>
              <td class="mono">${r.assignmentId}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    $("overviewTable").innerHTML = rows.length ? html : `<div class="small">No assignments yet.</div>`;
  }

  function renderModuleDetail(){
    const moduleId = $("analyticsModuleSelect").value;
    const mm = moduleMap();
    const mod = mm.get(String(moduleId));
    const em = employeeMap();

    const latestMap = latestAssignmentPerModule();
    const asg = latestMap.get(String(moduleId));

    if (!mod){
      $("moduleDetailPanel").innerHTML = `<div class="small">Unknown module.</div>`;
      return;
    }
    if (!asg){
      $("moduleDetailPanel").innerHTML = `<div class="small">No assignments yet for <b>${mod.title}</b>.</div>`;
      return;
    }

    const p = assignmentProgress(asg);
    const percent = p.total ? Math.round((p.done / p.total) * 100) : 0;
    const completedSet = new Set(p.completedIds.map(String));

    const assigned = p.targets.map(id => em.get(String(id))).filter(Boolean);
    const completed = assigned.filter(e => completedSet.has(String(e.employeeId)));
    const remaining = assigned.filter(e => !completedSet.has(String(e.employeeId)));

    $("moduleDetailPanel").innerHTML = `
      <div class="item">
        <div class="meta">
          <div class="a">${mod.title}</div>
          <div class="b">Latest assignment: <span class="mono">${asg.assignmentId}</span> â€¢ Progress: ${p.done}/${p.total} (${percent}%)</div>
          <div class="bar"><div style="width:${percent}%"></div></div>
        </div>
      </div>

      <div class="hr"></div>

      <details open>
        <summary>Assigned (${assigned.length}) <span class="small">Includes completed + remaining</span></summary>
        <div class="chips">
          ${assigned.length ? assigned.map(e => `<span class="chip muted">${formatName(e)}</span>`).join("") : `<span class="small">None.</span>`}
        </div>
      </details>

      <div style="height:10px"></div>

      <details>
        <summary>Completed (${completed.length})</summary>
        <div class="chips">
          ${completed.length ? completed.map(e => `<span class="chip ok">${formatName(e)}</span>`).join("") : `<span class="small">No completions yet.</span>`}
        </div>
      </details>

      <div style="height:10px"></div>

      <details>
        <summary>Remaining (${remaining.length})</summary>
        <div class="chips">
          ${remaining.length ? remaining.map(e => `<span class="chip muted">${formatName(e)}</span>`).join("") : `<span class="small">Everyone is complete âœ…</span>`}
        </div>
      </details>
    `;
  }

  function renderActivity(){
    const em = employeeMap();
    const mm = moduleMap();

    // Completed events with timestamps
    const events = (SNAP.completions||[])
      .filter(c => safeStr(c.status).toLowerCase() === "completed" && safeStr(c.completedAt).trim())
      .map(c => {
        const emp = em.get(String(c.employeeId));
        const mod = mm.get(String(c.moduleId));
        return {
          when: String(c.completedAt),
          employee: emp ? emp.name : c.employeeId,
          employeeId: String(c.employeeId),
          module: mod ? mod.title : c.moduleId,
          moduleId: String(c.moduleId),
          assignmentId: String(c.assignmentId || "")
        };
      })
      .sort((a,b) => b.when.localeCompare(a.when))
      .slice(0, 30);

    if (!events.length){
      $("activityTable").innerHTML = `<div class="small">No completions recorded yet.</div>`;
      return;
    }

    $("activityTable").innerHTML = `
      <table class="table">
        <thead>
          <tr>
            <th>When</th>
            <th>Employee</th>
            <th>Module</th>
            <th>Assignment</th>
          </tr>
        </thead>
        <tbody>
          ${events.map(e => `
            <tr>
              <td class="mono">${e.when}</td>
              <td><b>${e.employee}</b> <span class="small mono">(${e.employeeId})</span></td>
              <td>${e.module} <span class="small mono">(${e.moduleId})</span></td>
              <td class="mono">${e.assignmentId}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  // Simple no-library chart (bar chart)
  function renderChart(){
    const canvas = $("moduleChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const rows = getModuleStatsFromLatestAssignments();

    // Resize to actual display width for crispness
    const cssW = canvas.clientWidth || 860;
    const cssH = canvas.clientHeight || 260;
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    // Colors (theme-aware)
    const isLight = (document.documentElement.getAttribute("data-theme") === "light");
    const bg = isLight ? "#fbfcff" : "#0f1117";
    const grid = isLight ? "rgba(11,16,32,.12)" : "rgba(255,255,255,.12)";
    const text = isLight ? "rgba(11,16,32,.82)" : "rgba(242,244,248,.88)";
    const accent = isLight ? "rgba(10,163,127,.85)" : "rgba(62,232,201,.85)";

    const W = cssW, H = cssH;
    ctx.clearRect(0,0,W,H);

    // background
    ctx.fillStyle = bg;
    ctx.fillRect(0,0,W,H);

    // padding
    const padL = 54, padR = 12, padT = 12, padB = 34;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    // axes/grid
    ctx.strokeStyle = grid;
    ctx.lineWidth = 1;
    for (let i=0;i<=4;i++){
      const y = padT + (plotH * i/4);
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(W-padR, y);
      ctx.stroke();
    }

    // no data
    if (!rows.length){
      ctx.fillStyle = text;
      ctx.font = "13px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("No assignments yet.", padL, padT + 18);
      return;
    }

    // Bars
    const n = Math.min(rows.length, 8); // keep readable
    const shown = rows.slice(0, n).sort((a,b) => a.percent - b.percent);
    const gap = 10;
    const barW = (plotW - gap*(n-1)) / n;

    ctx.fillStyle = accent;

    shown.forEach((r, i) => {
      const x = padL + i*(barW + gap);
      const h = (r.percent/100) * plotH;
      const y = padT + (plotH - h);

      ctx.fillRect(x, y, barW, h);
    });

    // Labels
    ctx.fillStyle = text;
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;

    shown.forEach((r, i) => {
      const x = padL + i*(barW + gap);
      const pct = Math.round(r.percent) + "%";
      const label = (r.moduleTitle || "").slice(0, 10) + ((r.moduleTitle||"").length>10 ? "â€¦" : "");

      ctx.fillText(pct, x, H - 16);
      ctx.fillText(label, x, H - 2);
    });

    // Y axis labels
    ctx.fillStyle = text;
    ctx.font = "11px " + getComputedStyle(document.body).fontFamily;
    ["100%","75%","50%","25%","0%"].forEach((t,i)=>{
      const y = padT + (plotH * i/4) + 4;
      ctx.fillText(t, 10, y);
    });
  }

  // ---- Assignment modal wiring ----
  function openAssign(){ $("assignBackdrop").style.display = "flex"; }
  function closeAssign(){ $("assignBackdrop").style.display = "none"; }
  function refreshAssigneeVisibility(){
    const t = $("assigneeType").value;
    $("rolePickWrap").style.display = (t === "ROLE") ? "block" : "none";
    $("selectedPickWrap").style.display = (t === "SELECTED") ? "block" : "none";
  }

  // ---- Main refresh ----
  async function refresh(){
    setStatus("Refreshingâ€¦");
    const r = await api("getSnapshot");
    if (!r.ok){ setStatus("Error"); toast(r.error || "Failed to load"); return; }
    SNAP = r;

    setStatus(`Ready â€¢ v${r.version}`);
    renderKpis();
    renderEmployeePicker();
    renderModulePicker();
    renderRolePicker();
    renderSelectedEmployeesMulti();
    renderAssignments();
    renderEmployeeAssignments();
    renderDiagnostics();

    // If analytics is open, refresh it too
    if ($("analyticsBackdrop").style.display === "flex"){
      renderAnalyticsPickers();
      renderOverview();
      renderModuleDetail();
      renderActivity();
      setTimeout(renderChart, 30);
    }
  }

  // ---- Events ----
  $("themeBtn").addEventListener("click", toggleTheme);
  $("refreshBtn").addEventListener("click", refresh);

  $("seedBtn").addEventListener("click", async () => {
    setStatus("Seedingâ€¦");
    const r = await api("bootstrapSampleData");
    if (r.ok){
      lastSeedCounts = r.counts || null;
      toast(`Seeded: roles ${r.counts?.roles ?? "?"}, employees ${r.counts?.employees ?? "?"}, modules ${r.counts?.modules ?? "?"}`);
      await refresh();
    } else {
      setStatus("Error");
      toast(r.error || "Seed failed");
    }
  });

  $("asgFilter").addEventListener("change", renderAssignments);
  $("employeeSelect").addEventListener("change", renderEmployeeAssignments);

  $("assignBtn").addEventListener("click", () => {
    $("assigneeType").value = (SNAP && SNAP.roles && SNAP.roles.length) ? "ROLE" : "ALL";
    $("dueDateISO").value = "";
    $("notes").value = "";
    refreshAssigneeVisibility();
    openAssign();
  });

  $("closeAssignBtn").addEventListener("click", closeAssign);
  $("cancelAssignBtn").addEventListener("click", closeAssign);
  $("assignBackdrop").addEventListener("click", (e) => { if (e.target === $("assignBackdrop")) closeAssign(); });
  $("assigneeType").addEventListener("change", refreshAssigneeVisibility);

  $("createAssignmentBtn").addEventListener("click", async () => {
    const assigneeType = $("assigneeType").value;
    const selectedIds = Array.from($("selectedEmployeesMulti").selectedOptions).map(o => o.value);

    const payload = {
      moduleId: $("moduleSelect").value,
      assigneeType,
      targetRoleId: $("targetRoleId").value,
      selectedEmployeeIdsCSV: (assigneeType === "SELECTED") ? selectedIds.join(",") : "",
      dueDateISO: $("dueDateISO").value,
      notes: $("notes").value,
      createdBy: $("createdBy").textContent
    };

    if (!payload.moduleId){ toast("No modules available (seed data)."); return; }
    if (payload.assigneeType === "ROLE" && !payload.targetRoleId){ toast("Pick a role"); return; }
    if (payload.assigneeType === "SELECTED" && !payload.selectedEmployeeIdsCSV.trim()){ toast("Select employees"); return; }

    const r = await api("createAssignment", payload);
    if (r.ok){ toast("Assignment created"); closeAssign(); await refresh(); }
    else toast(r.error || "Error creating assignment");
  });

  // Analytics events
  $("analyticsBtn").addEventListener("click", () => openAnalytics("overview"));
  $("closeAnalyticsBtn").addEventListener("click", () => closeBackdrop("analyticsBackdrop"));
  $("closeAnalyticsBtn2").addEventListener("click", () => closeBackdrop("analyticsBackdrop"));
  $("analyticsBackdrop").addEventListener("click", (e) => { if (e.target === $("analyticsBackdrop")) closeBackdrop("analyticsBackdrop"); });

  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      const tab = btn.getAttribute("data-tab");
      setAnalyticsTab(tab);
      if (tab === "overview") { renderOverview(); setTimeout(renderChart, 30); }
      if (tab === "module") { renderModuleDetail(); }
      if (tab === "activity") { renderActivity(); }
    });
  });

  $("analyticsModuleSelect").addEventListener("change", renderModuleDetail);

  // Boot
  (async function(){
    setStatus("Connectingâ€¦");
    const ping = await api("ping");
    if (!ping.ok){ setStatus("Error"); toast(ping.error || "Could not connect"); return; }
    setStatus(`Connected â€¢ v${ping.version}`);
    await refresh();
  })();
</script>
</body>
</html>
